# wpt.fyi API

This package defines and implements HTTP API endpoints for [wpt.fyi](https://wpt.fyi/), and this
document covers usage and parameters of those endpoints.

## Endpoints

An exhaustive list of the endpoints can be found in `routes.go`.

 - [/api/run](#apirun)
 - [/api/runs](#apiruns)
 - [/api/diff](#apidiff)
 - [/results](#results)

### /api/run

Gets a specific (single) TestRun metadata, for a given SHA[0:10] and platform.

__Parameters__

__`sha`__ :  SHA[0:10] of the runs to get, or the keyword `latest`. Defaults to `latest`.

__`platform`__ : browser[version[os[version]]]. e.g. `chrome-63.0-linux`

### /api/runs

Gets the TestRun metadata for all runs for a given SHA[0:10].

__Parameters__

__`sha`__ : SHA[0:10] of the runs to get, or the keyword `latest`. Defaults to `latest`.

__`from`__ : RFC3339 timestamp, for which to include runs that occured after the given time.

__`max-count`__ : Maximum number of runs to get (for each browser). Only relevant when `sha` is `latest`. Maximum of 500.

### /api/diff

Computes a TestRun summary JSON blob of the differences between two TestRun
summary blobs.

__Parameters__

__`before`__ : [browser]@[sha] spec for the TestRun to use as the before state.

__`after`__ : [browser]@[sha] spec for the TestRun to use as the after state.

__`path`__ : Test path to filter by. `path` is a repeatable query parameter.

__`filter`__ : Differences to include in the summary.
 - `A` : Added - tests which are present after, but not before.
 - `D` : Deleted - tests which are present before, but not after.
 - `C` : Changed - tests which are present before and after, but the results summary is different.
 - `U` : Unchanged - tests which are present before and after, and the results summary count is not different.

### /results

Performs an HTTP redirect for the results summary JSON blob of the given TestRun.

__Parameters__

__`browser`__ : Browser to fetch the results for, e.g. `chrome`

__`sha`__ : SHA[0:10] of the TestRun to fetch, or the keyword `latest`. Defaults to `latest`.

### /api/manifest

Gets the JSON of the WPT manifest GitHub release asset, for a given sha (defaults to latest).

__Parameters__

__`sha`__ : SHA of the [WPT](https://github.com/web-platform-tests/wpt) repo PR for which to fetch,
    the manifest, or the keyword `latest`. (Defaults to `latest`.)

NOTE: The full SHA of the fetched manifest is returned in the HTTP response header `x-wpt-sha`, e.g.

    x-wpt-sha: abcdef0123456789abcdef0123456789abcdef01

The high-level structure of the `v4` manifest is as follows:

    {
      "items": {
        "manual": {
            "file/path": [
              manifest_item,
              ...
            ],
            ...
        },
        "reftest": {...},
        "testharness": {...},
        "wdspec": {...},
      },
    }

`manifest_item` is an **array** (nested in the map's `"file/path"` value's array) with varying contents. Loosely,

- For `testharness` entries: `[url, extras]`
  - `extras` example: `{"timeout": "long", "testdriver": True}`
- For `reftest` entries: `[url, references, extras]`
  - `references` example: `[[reference_url1, "=="], [reference_url2, "!="], ...]`
  - `extras` example: `{"timeout": "long", "viewport_size": ..., "dpi": ...}`

## /api/results/upload

Uploads a wptreport to the dashboard to create the test run.

This endpoint only accepts POST requests. Requests need to be authenticated via HTTP basic auth.
Please contact [Ecosystem Infra](mailto:ecosystem-infra@chromium.org) if you want to register as a
"test runner", to upload results.

### File payload

__Content type__: `multipart/form-data`

__Parameters__

__`result_file`__: A gzipped JSON file produced by `wpt run --log-wptreport`.

The JSON file roughly looks like this:

```json
{
  "results": [...],
  "run_info": {
    "revision": "WPT revision of the test run",
    "product": "your browser",
    "browser_version": "version of the browser",
    "os": "your os",
    "os_version": "OPTIONAL OS version",
    ...
  }
}
```

Note that `run_info.{revision,product,browser_version,os}` are required, and should be automatically
generated by `wpt run`. If for some reason the report does not contain these fields (e.g. old WPT
version, Sauce Labs, or custom runners), they can be overridden with the following *optional*
parameters in the POST payload (this is __NOT__ recommended; please include metadata in the reports
whenever possible):

* __`revision`__
* __`browser_name`__ (note that it is not called `product` here)
* __`browser_version`__
* __`os_name`__ (note that it is not called `os` here)
* __`os_version`__

### URL payload

__Content type__: `application/x-www-form-urlencoded`

__Parameters__

TODO
