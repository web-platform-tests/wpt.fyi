name: Deploy
on:
  push:
    branches:
      - main
      - github-actions # TODO: remove
jobs:
  deploy-staging:
    name: Deploy staging.wpt.fyi
    runs-on: ubuntu-latest
    env:
      DOCKER_IMAGE: webplatformtests/wpt.fyi:latest
      # TODO(kyleju): fix this
      DOCKER_INSTANCE: wptd-dev-0000
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v2

      - name: secrets
        run: echo "$GCLOUD_KEY_FILE_JSON" > client-secret.json
        env:
         GCLOUD_KEY_FILE_JSON: ${{ secrets.GCLOUD_KEY_FILE_JSON }}

      - name: pre-installation
        run: |
          docker pull "${DOCKER_IMAGE}"
          bash ./util/docker-dev/run.sh -d -q

      - name: installation
        run: docker exec -t "${DOCKER_INSTANCE}" make go_build;

# TODO Need to run set -e?

      - name: build webapp
        run: ./util/deploy-staging.sh -f webapp/web/app.staging.yaml

      - name: build processor
        run: ./util/deploy-staging.sh -f results-processor

      - name: build searchcache
        run: ./util/deploy-staging.sh -f api/query/cache/service/app.staging.yaml

      - name: Run puppeteer_chrome_test tests
        run: docker exec -t "${DOCKER_INSTANCE}" make puppeteer_chrome_test
