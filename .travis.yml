# Copyright 2017 The WPT Dashboard Project. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

sudo: required

branches:
  only:
    - master

# Ensure latest stable chrome for WCT
addons:
  chrome: stable

services:
  - docker

matrix:
  include:
    - env:
        - MAKE_TEST_TARGET=python_test
    - env:
        - MAKE_TEST_TARGET=integration_test
    - env:
        - MAKE_TEST_TARGET=lint
    - env:
        - MAKE_TEST_TARGET=go_test
    - if: type = pull_request
      env:
        - secure: "yj2nfr9a0kbeMFMt8mPdu5e/3/LRkbejEHUtaMJwHYBmNAUFv75dD7I7s1tDPfYpxLlgXwTTHOZyJ7nUFFE1ae8nc1spcPbjuX0MZgXXTe5erlcheIHN1SWw7mC0j5EeLDuFIrHHicAZChIO2Djn81xlm09ZXHk3P5tMkk6enEmhpBvj+ukbX/IYQBExjquTGBD7GJGIgAokRNeP5tjRLudT7R4jQ5o90+YPgnQhSVm1O17HVlq4nmwsWcEY5nwRW/ZVQm6Uhtjw7LHYt7x2Olz/aMgmU2Ir6r0W9+VRhmKph2o198Q2ju76bIL5KxsfZ282GtYDeeq9Aue9haNIyiCZyqGDpHHVjWagnh6AOudknLNSQ+x9WrAmr3RO3XfRDdRQ4VtSrqW0oxW/t9300/ywE0+fvnZAPwJqkIqnHwT7DcchTlf+TtZwrSURUx9D+xWxIZtuubmRrHc/FedAUfnTc7239Lc4fHNxvhm8iNretvzvscQO04PV3RiImUZV9T+KONtaxYHeOTnyTIEPZhXwdZxuvABGpFysAvYY+Fnirul9ngYngfx8InMz+5njJGw5icQLf/IwLL6nT1B2QNxtVNQ1hZAGPuQu2athtEKX7STGXZZvMDG9QXDFhV/iHtmm576I+KwHfvsfz+5DHU9mM/qScZTPjaOHfQ88Bjg="
        - DEPLOY_PR_STAGING=true
    - if: (type = push) AND (branch = master)
      env:
        - secure: "yj2nfr9a0kbeMFMt8mPdu5e/3/LRkbejEHUtaMJwHYBmNAUFv75dD7I7s1tDPfYpxLlgXwTTHOZyJ7nUFFE1ae8nc1spcPbjuX0MZgXXTe5erlcheIHN1SWw7mC0j5EeLDuFIrHHicAZChIO2Djn81xlm09ZXHk3P5tMkk6enEmhpBvj+ukbX/IYQBExjquTGBD7GJGIgAokRNeP5tjRLudT7R4jQ5o90+YPgnQhSVm1O17HVlq4nmwsWcEY5nwRW/ZVQm6Uhtjw7LHYt7x2Olz/aMgmU2Ir6r0W9+VRhmKph2o198Q2ju76bIL5KxsfZ282GtYDeeq9Aue9haNIyiCZyqGDpHHVjWagnh6AOudknLNSQ+x9WrAmr3RO3XfRDdRQ4VtSrqW0oxW/t9300/ywE0+fvnZAPwJqkIqnHwT7DcchTlf+TtZwrSURUx9D+xWxIZtuubmRrHc/FedAUfnTc7239Lc4fHNxvhm8iNretvzvscQO04PV3RiImUZV9T+KONtaxYHeOTnyTIEPZhXwdZxuvABGpFysAvYY+Fnirul9ngYngfx8InMz+5njJGw5icQLf/IwLL6nT1B2QNxtVNQ1hZAGPuQu2athtEKX7STGXZZvMDG9QXDFhV/iHtmm576I+KwHfvsfz+5DHU9mM/qScZTPjaOHfQ88Bjg="
        - DEPLOY_STAGING=true
        - MAKE_TEST_TARGET=go_webdriver_test
        - MAKE_TEST_FLAGS="STAGING=true"

before_install: |
  export DOCKER_IMAGE=wptd-dev
  export DOCKER_INSTANCE=wptd-dev-${RANDOM}
  # Decrypt client-secret.json for Appengine.
  openssl aes-256-cbc -K $encrypted_c8659b25fe66_key -iv $encrypted_c8659b25fe66_iv -in client-secret.json.enc -out client-secret.json -d

  docker build -t "${DOCKER_IMAGE}" .
  bash ./util/docker-dev/run.sh -d -q

install:
  - | # Set the user as home dir owner in the docker instance
    docker exec -u 0:0 "${DOCKER_INSTANCE}" chown -R $(id -u $USER):$(id -g $USER) /home/user

script:
  - |
    # Deploy PR to staging environment (only when Travis secrets are available).
    # Note: Done here (in 'script', not 'deploy') because we need deploy to happen before staging webdriver test.
    if [ "${DEPLOY_STAGING}" == "true" ]; then
      bash util/travis-deploy-staging.sh -f webapp;
      bash util/travis-deploy-staging.sh -f results-processor;
      bash util/travis-deploy-staging.sh -f revisions/service;
    elif [ "${DEPLOY_PR_STAGING}" == "true" ]; then
      bash util/travis-deploy-staging.sh webapp;
      bash util/travis-deploy-staging.sh results-processor;
      bash util/travis-deploy-staging.sh revisions/service;
    else
      echo "Not on master or a PR. Skipping deployment.";
    fi
  - | # Run tests
    if [ "${MAKE_TEST_TARGET}" != "" ]; then
      docker exec -t -u $(id -u $USER):$(id -g $USER) "${DOCKER_INSTANCE}" make "${MAKE_TEST_TARGET}" ${MAKE_TEST_FLAGS}
    fi
