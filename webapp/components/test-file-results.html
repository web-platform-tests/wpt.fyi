<!--
Copyright 2017 The WPT Dashboard Project. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="test-runs.html">
<link rel="import" href="test-run.html">
<link rel="import" href="test-file-results-table-terse.html">
<link rel="import" href="test-file-results-table-verbose.html">

<dom-module id="test-file-results">
  <template>
    <style>
      :host {
        display: block;
        font-size: 16px;
      }
      h1 {
        font-size: 1.5em;
      }
      .right {
        display: flex;
        justify-content: flex-end;
      }
      .right .pad {
        padding: 8px;
      }
      paper-toggle-button {
        --paper-toggle-button-checked-bar-color:  var(--paper-blue-500);
        --paper-toggle-button-checked-button-color:  var(--paper-blue-700);
        --paper-toggle-button-checked-ink-color: var(--paper-blue-300);
      }
    </style>

    <div class="right">
      <label class="pad">Verbose</label>
      <paper-toggle-button class="pad" checked="{{isVerbose}}">
      </paper-toggle-button>
    </div>

    <template is="dom-if" if="{{!isVerbose}}">
      <test-file-results-table-terse
          test-runs="[[testRuns]]"
          subtest-names="[[subtestNames]]">
      </test-file-results-table-terse>
    </template>

    <template is="dom-if" if="{{isVerbose}}">
        <test-file-results-table-verbose
            test-runs="[[testRuns]]"
            subtest-names="[[subtestNames]]">
        </test-file-results-table-verbose>
      </template>
  </template>

  <script>
    /* global TestRunsBase */
    class TestFileResults extends TestRunsBase {
      static get is() {
        return 'test-file-results';
      }

      static get properties() {
        return {
          subtestNames: {
            type: Array,
            value: [],
          },
          isTestHarness: {
            type: Boolean,
            value: false,
          },
          isVerbose: {
            type: Boolean,
            value: false,
          },
        };
      }

      async connectedCallback() {
        await super.connectedCallback();
        console.assert(this.path);
        console.assert(this.path[0] === '/');
      }

      static get observers() {
        return ['fetchTestFile(path, testRuns)'];
      }

      async fetchTestFile(path, testRuns) {
        this.subtestNames = []; // Clear any existing rows.
        if (!path || !testRuns) {
          return;
        }
        const resultPerTestRun = await Promise.all(
          testRuns.map(tr => this.loadResultFile(tr)));

        let isTestHarness = false;
        const subtestNames = ['STATUS'];
        resultPerTestRun.forEach((resultData, i) => {
          if (!resultData) {
            testRuns[i].subtests = {};
            testRuns[i].subtests['STATUS'] = { status: '(results not found)' };
            return;
          }
          testRuns[i].subtests = {};
          testRuns[i].subtests['STATUS'] = { status: resultData.status };
          if (['OK', 'ERROR'].includes(resultData.status)) {
            isTestHarness = true;
          }

          for (let subtestResult of resultData.subtests) {
            testRuns[i].subtests[subtestResult.name] = subtestResult;
            if (!subtestNames.includes(subtestResult.name)) {
              subtestNames.push(subtestResult.name);
            }
          }
        });

        this.isTestHarness = isTestHarness;
        this.subtestNames = subtestNames;
      }

      async loadResultFile(testRun) {
        const url = this.resultsURL(testRun, this.path);
        const response = await window.fetch(url);
        if (!response.ok) {
          return null;
        }
        return response.json();
      }

      resultsURL(testRun, path) {
        if (testRun.revision === 'diff') {
          return `${testRun.results_url}&path=${encodeURIComponent(path)}`;
        }
        path = this.encodeTestPath(path);
        // This is relying on the assumption that result files end with '-summary.json.gz'.
        const resultsBase = testRun.results_url.slice(0, testRun.results_url.lastIndexOf('-summary.json.gz'));
        return `${resultsBase}${path}`;
      }
    }

    window.customElements.define(TestFileResults.is, TestFileResults);
  </script>
</dom-module>
