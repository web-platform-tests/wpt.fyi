<!--
Copyright 2018 The WPT Dashboard Project. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<dom-module id="abstract-test-file-results-table">
  <script>
    // eslint-disable-next-line no-unused-vars
    const AbstractTestFileResultsTable = superClass => class extends superClass {
      static get properties() {
        return {
          subtestNames: {
            type: Array,
            value: [],
          },
          isTestHarness: {
            type: Boolean,
            value: false,
          },
        };
      }

      static get observers() {
        return ['fetchTestFile(path, testRuns)'];
      }

      async fetchTestFile(path, testRuns) {
        if (!path || !testRuns) {
          this.subtestNames = [];
          return;
        }

        const resultPerTestRun = await Promise.all(
          testRuns.map(tr => this.loadResultFile(tr)));

        let isTestHarness = false;
        const subtestNames = ['STATUS'];
        resultPerTestRun.forEach((resultData, i) => {
          if (!resultData) {
            testRuns[i].subtests = {};
            testRuns[i].subtests['STATUS'] = { status: '(results not found)' };
            return;
          }
          testRuns[i].subtests = {};
          testRuns[i].subtests['STATUS'] = { status: resultData.status };
          if (['OK', 'ERROR'].includes(resultData.status)) {
            isTestHarness = true;
          }

          for (let subtestResult of resultData.subtests) {
            testRuns[i].subtests[subtestResult.name] = subtestResult;
            if (!subtestNames.includes(subtestResult.name)) {
              subtestNames.push(subtestResult.name);
            }
          }
        });

        this.isTestHarness = isTestHarness;
        this.subtestNames = subtestNames;
      }

      async loadResultFile(testRun) {
        const url = this.resultsURL(testRun, this.path);
        const response = await window.fetch(url);
        if (!response.ok) {
          return null;
        }
        return response.json();
      }

      resultsURL(testRun, path) {
        path = this.encodeTestPath(path);
        // This is relying on the assumption that result files end with '-summary.json.gz'.
        const resultsBase = testRun.results_url.slice(0, testRun.results_url.lastIndexOf('-summary.json.gz'));
        return `${resultsBase}${path}`;
      }

      subtestNameForDisplay(subtestName, isTestHarness) {
        if (subtestName !== 'STATUS') {
          return subtestName;
        }
        return isTestHarness ? 'Harness status' : 'File status';
      }

      subtestResultForTestRun(testRun, subtestName) {
        if (!testRun) {
          return null;
        }
        if (!testRun.subtests) {
          return null;
        }
        if (!testRun.subtests[subtestName]) {
          return null;
        }
        return testRun.subtests[subtestName].status;
      }

      // eslint-disable-next-line no-unused-vars
      subtestMessageForTestRun(testRun, subtestName) {
        return 'NOT IMPLEMENTED';
      }

      computeSubtestThWidth(testRuns) {
        return `${200 / (testRuns.length + 2)}%`;
      }

      computeRunThWidth(testRuns) {
        return `${100 / (testRuns.length + 2)}%`;
      }
    };
  </script>
</dom-module>
