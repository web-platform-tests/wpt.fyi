<!--
Copyright 2018 The WPT Dashboard Project. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="runs.html">

<dom-module id="test-file-results-time-series">
  <template>
    <style>
      .browser {
        display: flex;
      }
      .browser-name {
        writing-mode: vertical-rl;
        text-orientation: sideways-right;
        border-right: 1px solid black;
        padding: 8px 4px;
      }
      .browser-result {
        padding: 8px 0;
      }
      .browser-results {
        display: flex;
      }
      .browser-result-status {
        cursor: default;
        border: 1px solid #ddd;
        background-color: #eee;
        width: 10px;
        height: 10px;
      }
      .browser-result-status.OK, .browser-result-status.PASS {
        background-color: rgb(90, 242, 113);
      }
      .browser-result-status.FAIL {
        background-color: rgb(242, 90, 90);
      }
    </style>
    <template is="dom-repeat" items="[[results]]" as="browserResults">
      <div class="browser">
        <div class="browser-name">[[browserResults.browserName]]</div>
        <div class="browser-results"></div>
        <template is="dom-repeat" items="[[browserResults.runResults]]" as="runResult">
            <div class="browser-result">
              <!-- Tooltip or something associated with run? -->
              <template is="dom-repeat" items="[[runResult.results]]" as="result">
                <div
                    class$="browser-result-status [[result.status]]"
                    onmouseenter="[[bindResultHover(runResult.run, result.name)]]">&nbsp;</div>
              </template>
            </div>
        </template>
      </div>
    </template>

    <pre id="status">&nbsp;</pre>
  </template>
  <script>
    /* global TestRunsBase */
    class TestFileResultsTimeSeries extends TestRunsBase {
      static get is() {
        return 'test-file-results-time-series';
      }

      static get properties() {
        return {
          maxCount: {
            type: Number,
            value: 20,
          },
          labels: {
            type: Array,
            value: [],
          },
          results: {
            type: Array,
            value: [],
          },
        };
      }

      static get observers() {
        return [
          // Observe testRuns bound to component. Expect each to have its
          // subtests property eventually filled out (as in TestFileResults)
          // logic).
          'onTestRuns(testRuns)',
        ];
      }

      // on-status-box-hover: Update status tag with summary of source run+test.
      bindResultHover(run, subTestName) {
        return () => {
          let statusElement = this.shadowRoot.querySelector('#status');
          statusElement.textContent =
              `${run.browser_name} ${run.browser_version} ${run.os_name} ${run.os_version} @ ${run.time_start} : ${subTestName}`;

        };
      }

      onTestRuns(testRuns) {
        // Reduce this.testRuns, which may have testRun.subtests filled out
        // (or may not) to browserName grouped structure:
        // [{browserName, runResults: [{run, results: [resultStatus]}]}].
        this.results = testRuns.reduce((acc, run) => {
          const browserResultsIdx = acc
            .findIndex(br => br.browserName === run.browser_name);
          let browserResults = acc[browserResultsIdx];
          if (!browserResults) {
            browserResults = {
              browserName: run.browser_name,
              runResults: [],
            };
            acc.push(browserResults);
          }
          browserResults.runResults.push({
            run,
            results: run.subtests ? Object.keys(run.subtests)
              .map(name => {
                return {name, status: run.subtests[name].status};
              }) : [],
          });

          return acc;
        }, []);
        console.log('testRuns', testRuns);
      }
    }

    window.customElements.define(TestFileResultsTimeSeries.is, TestFileResultsTimeSeries);
  </script>
</dom-module>
