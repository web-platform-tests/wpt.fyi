<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <script src="../../node_modules/@webcomponents/webcomponentsjs/webcomponents-bundle.js"></script>
  <script src="../../node_modules/wct-browser-legacy/browser.js"></script>

  <script type="module" src="../test-search.js"></script>
</head>
<body>
  <test-fixture id="test-search-fixture">
    <template>
      <test-search></test-search>
    </template>
  </test-fixture>

  <script type="module">
import { TestSearch } from '../test-search.js';

suite('<test-search>', () => {
  suite('Parser/interpreter', () => {
    const assertQueryParse = (query, structuredQuery) => {
      const G = TestSearch.QUERY_GRAMMAR;
      const S = TestSearch.QUERY_SEMANTICS;
      const p = G.match(query);
      assert.isTrue(p.succeeded());
      assert.deepEqual(structuredQuery, S(p).eval());
    };

    test('simple pattern', () => {
      assertQueryParse('2dcontext', {exists: [{pattern: '2dcontext'}]});
    });

    test('test status eq', () => {
      assertQueryParse('sTaTuS:oK', {status: 'OK'});
    });

    test('test status neq', () => {
      assertQueryParse('StAtUs:!FaIl', {status: {not: 'FAIL'}});
    });

    test('browser test status eq', () => {
      assertQueryParse('cHrOmE:oK', {exists: [{browser_name: 'chrome', status: 'OK'}]});
    });

    test('browser test status neq', () => {
      assertQueryParse('sAfArI:!FaIl', {exists: [{browser_name: 'safari', status: {not: 'FAIL'}}]});
    });

    test('pattern + test status', () => {
      assertQueryParse('cssom firefox:timeout', {
        exists: [
          {pattern: 'cssom'},
          {browser_name: 'firefox', status: 'TIMEOUT'},
        ],
      });
    });

    test('pattern | test status', () => {
      assertQueryParse('cssom or firefox:timeout', {
        exists: [{
          or: [
            {pattern: 'cssom'},
            {browser_name: 'firefox', status: 'TIMEOUT'},
          ]
        }],
      });
    });

    test('implicit and, or', () => {
      assertQueryParse('a b or c', {
        exists: [
          {pattern: 'a'},
          {
            or: [
              {pattern: 'b'},
              {pattern: 'c'},
            ],
          },
        ],
      });
    });

    test('explicit and, or', () => {
      assertQueryParse('a and b or c', {
        exists: [{
          or: [
            {
              and: [
                {pattern: 'a'},
                {pattern: 'b'},
              ],
            },
            {pattern: 'c'},
          ],
        }]
      });
    });

    test('parens', () => {
      assertQueryParse('a and ( b or c )', {
        exists: [{
          and: [
            {pattern: 'a'},
            {
              or: [
                {pattern: 'b'},
                {pattern: 'c'},
              ],
            },
          ],
        }]
      });

      assertQueryParse('a or ( b and c )', {
        exists: [{
          or: [
            {pattern: 'a'},
            {
              and: [
                {pattern: 'b'},
                {pattern: 'c'},
              ],
            },
          ],
        }],
      });
    });

    test('nested or/and/not', () => {
      assertQueryParse('(chrome:pass or edge:pass) (firefox:!pass and firefox:!ok)', {
        exists: [
          {
            or: [
              {browser_name: 'chrome', status: 'PASS'},
              {browser_name: 'edge', status: 'PASS'},
            ]
          },
          {
            and: [
              {browser_name: 'firefox', status: { not: 'PASS'} },
              {browser_name: 'firefox', status: { not: 'OK'} },
            ],
          },
        ]
      });
      assertQueryParse(
        'chrome:pass (!(firefox:pass or firefox:ok) and !(safari:pass or safari:ok) and !(edge:pass or edge:ok))',
        {
          exists: [
            {browser_name: 'chrome', status: 'PASS'},
            {
              and: ['firefox','safari','edge'].map(b => {
                return {
                  not: {
                    or: [
                      {browser_name: b, status: 'PASS'},
                      {browser_name: b, status: 'OK'},
                    ]
                  }
                };
              })
            },
          ]
        }
      );
    });

    test('all features', () => {
      assertQueryParse('firefox:pass a | chrome:fail and ( b & c )', {
        exists: [
          {browser_name: 'firefox', status: 'PASS'},
          {
            or: [
              {pattern: 'a'},
              {
                and: [
                  {browser_name: 'chrome', status: 'FAIL'},
                  {
                    and: [
                      {pattern: 'b'},
                      {pattern: 'c'},
                    ],
                  },
                ],
              },
            ],
          },
        ]
      });
    });
  });
});
</script>
</body>
</html>
