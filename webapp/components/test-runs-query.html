<!--
Copyright 2018 The WPT Dashboard Project. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="./product-info.html">

<dom-module id="test-runs-query">
  <script>
    /**
     * Behaviour class for re-use of test-runs fetching behaviour.
     */
    // eslint-disable-next-line no-unused-vars
    const TestRunsQuery = (superClass) => class extends ProductInfo(superClass) {
      static get properties() {
        return {
          /* Parsed product objects, computed from the spec strings */
          products: {
            type: Array,
            notify: true,
            value: [],
          },
          productSpecs: {
            type: Array,
            notify: true,
            value: [],
          },
          labels: {
            type: Array,
            value: [],
          },
          maxCount: Number,
          sha: String,
          aligned: Boolean,
          isLatest: {
            type: Boolean,
            computed: 'computeIsLatest(sha)'
          },
          queryParams: {
            type: Object,
            computed: 'testRunQueryParams(sha, labels, productSpecs, maxCount)',
          },
          query: {
            type: String,
            computed: 'computeQuery(queryParams)',
          }
        };
      }

      ready() {
        super.ready();
        if (this.productSpecs && this.productSpecs.length
            && !(this.product && this.products.length)) {
          this.products = this.productSpecs.map(p => this.parseProductSpec(p));
        }
        this._createMethodObserver('productsUpdated(products, products.*)');
      }

      productsUpdated(products, itemChange) {
        this.productSpecs = (products || []).map(p => this.getSpec(p));
      }

      computeIsLatest(sha) {
        return !sha || sha === 'latest';
      }

      testRunQueryParams(sha, labels, productSpecs, maxCount) {
        const params = {};
        if (sha) {
          params.sha = sha;
        }
        if (labels && labels.length) {
          params.label = labels;
        }
        if (productSpecs && productSpecs.length) {
          params.product = productSpecs;
        }
        maxCount = maxCount || this.defaultMaxCount;
        if (maxCount) {
          params['max-count'] = maxCount;
        }
        if (this.aligned) {
          params.aligned = true;
        }
        return params;
      }

      computeQuery(params) {
        if (Object.keys(params).length < 1) {
          return '';
        }
        const url = new URL(window.location.origin);
        for (const k of Object.keys(params)) {
          const v = params[k];
          if (Array.isArray(v)) {
            v.forEach(i => url.searchParams.append(k, i));
          } else {
            url.searchParams.set(k, params[k]);
          }
        }
        return url.search;
      }
    }
  </script>
</dom-module>
